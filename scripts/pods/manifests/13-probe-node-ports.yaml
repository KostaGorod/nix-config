apiVersion: v1
kind: Pod
metadata:
  name: probe-node-ports
spec:
  restartPolicy: Never
  containers:
    - name: probe
      image: busybox:1.36.1
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -u

          HOST_IP="${HOST_IP:?}"
          echo "[probe] HOST_IP=${HOST_IP}"

          check_port() {
            port="$1"
            if nc -z -w 2 "$HOST_IP" "$port" >/dev/null 2>&1; then
              echo "[probe] PORT_${port}=OPEN"
            else
              echo "[probe] PORT_${port}=CLOSED"
            fi
          }

          check_port 6443
          check_port 10250
          check_port 2379
          check_port 2380

          exit 0
      env:
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
