name: Rebase develop onto main

on:
  push:
    branches: [main]
  workflow_dispatch: {}
  schedule:
    # Nightly safety net in case main moves without a push event (rare)
    - cron: "23 2 * * *"

concurrency:
  group: rebase-develop-onto-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    # Safety: don't run in forks
    if: github.repository == 'KostaGorod/nix-config'

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch branches
        run: |
          git fetch origin main develop --prune

      - name: Sync develop with main (rebase)
        env:
          TARGET_BRANCH: develop
          BASE_BRANCH: main
        run: |
          set -euo pipefail

          git checkout "${TARGET_BRANCH}"
          git reset --hard "origin/${TARGET_BRANCH}"

          # 1) If develop already contains main, nothing to do.
          if git merge-base --is-ancestor "origin/${BASE_BRANCH}" "origin/${TARGET_BRANCH}"; then
            echo "${TARGET_BRANCH} already contains ${BASE_BRANCH}; nothing to do."
            exit 0
          fi

          # 2) If develop is strictly behind main (no unique commits), fast-forward.
          if git merge-base --is-ancestor "origin/${TARGET_BRANCH}" "origin/${BASE_BRANCH}"; then
            echo "Fast-forwarding ${TARGET_BRANCH} to ${BASE_BRANCH}."
            git merge --ff-only "origin/${BASE_BRANCH}"
            git push origin "${TARGET_BRANCH}"
            exit 0
          fi

          # 3) Otherwise rebase develop onto main (rewrites develop history).
          echo "Rebasing ${TARGET_BRANCH} onto ${BASE_BRANCH}."
          git rebase "origin/${BASE_BRANCH}"

          # Rebase rewrites history; force-with-lease is the safest push mode.
          git push --force-with-lease origin "${TARGET_BRANCH}"
