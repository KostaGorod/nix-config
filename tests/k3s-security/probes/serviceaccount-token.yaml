apiVersion: v1
kind: Pod
metadata:
  name: probe-serviceaccount-token
spec:
  restartPolicy: Never
  containers:
    - name: probe
      image: curlimages/curl:8.6.0
      command: ["sh", "-c"]
      args:
        - |
          set -eu

          TOKEN_PATH=/var/run/secrets/kubernetes.io/serviceaccount/token
          CA_PATH=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

          if [ -f "$TOKEN_PATH" ]; then
            echo "[probe] SA_TOKEN_PRESENT=yes"
          else
            echo "[probe] SA_TOKEN_PRESENT=no"
            exit 0
          fi

          if [ ! -f "$CA_PATH" ]; then
            echo "[probe] SA_CA_PRESENT=no"
            exit 0
          fi

          if [ -z "${POD_NAMESPACE:-}" ]; then
            echo "[probe] POD_NAMESPACE_MISSING=yes"
            exit 0
          fi

          TOKEN=$(cat "$TOKEN_PATH")
          URL="https://kubernetes.default.svc/api/v1/namespaces/${POD_NAMESPACE}/secrets?limit=1"
          CODE=$(curl -sS -o /dev/null -w "%{http_code}" --cacert "$CA_PATH" -H "Authorization: Bearer $TOKEN" "$URL" || true)
          echo "[probe] LIST_SECRETS_HTTP_CODE=$CODE"
      env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
