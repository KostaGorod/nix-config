apiVersion: v1
kind: Pod
metadata:
  name: probe-privileged-hostpath
spec:
  restartPolicy: Never
  containers:
    - name: probe
      image: ubuntu:22.04
      command: ["/bin/bash", "-c"]
      args:
        - |
          set -euo pipefail

          echo "[probe] privileged+hostPath is allowed"
          echo "[probe] checking host filesystem access via /host"

          if [[ -r /host/etc/shadow ]]; then
            echo "[probe] host /etc/shadow is readable: YES"
          else
            echo "[probe] host /etc/shadow is readable: NO"
          fi

          if [[ -e /host/etc/rancher/k3s/k3s.yaml ]]; then
            echo "[probe] host k3s kubeconfig exists: YES"
            mode=$(stat -c '%a' /host/etc/rancher/k3s/k3s.yaml)
            echo "[probe] K3S_KUBECONFIG_MODE=$mode"
          else
            echo "[probe] host k3s kubeconfig exists: NO"
          fi

          echo "[probe] host nix store mounted: $(test -d /host/nix/store && echo YES || echo NO)"

          echo "[probe] done"
      securityContext:
        privileged: true
      volumeMounts:
        - name: host-root
          mountPath: /host
          readOnly: true
  volumes:
    - name: host-root
      hostPath:
        path: /
